## Phoenix Refit ‚Äî Session Control, Signal Lifecycle, Swarm Feed Overhaul
10/29/2025

### Summary
This refactor transforms Phoenix Cockpit into a stable, signal-safe, multi-process control environment with full-featured session lifecycle management, deterministic teardown, and a modernized Swarm Feed UI with sound alerts and context tagging.

## Core Infrastructure

- Session Lifecycle Control

 - Implemented force_close handshake from cockpit ‚Üí subprocess to properly trigger SessionWindow.closeEvent() in child processes.

 - Added _poll_conn() and heartbeat timers to maintain pipe activity.

 - Introduced graceful cleanup via "exit_ack" and exit message handling for deterministic process reaping.

 - Added session ID + deployment ID propagation through all channels for end-to-end traceability.

- Watchdog / Reaper

 - Upgraded _reap_dead_sessions() to detect silent or crashed sessions using is_alive() and last heartbeat timestamps.

 - Automatic cleanup of tab_stack, _active_sessions, and pipe handles without cross-thread race conditions.

- Phantom Session Elimination

 - Forced proper QWindow.close() propagation from tab close events.

 - Child sessions now respond to "force_close" ‚Üí triggers SessionWindow.closeEvent() ‚Üí detaches buses ‚Üí clean MIRV logs:

- [MIRV] üîª Sent force_close
- [SESSION] Received external close
- [SESSION] closeEvent triggered
- [MIRV] üõë Session requested exit
- [MIRV] Cleaned up session 

## Panel Architecture

- PhoenixPanelInterface Standardization

 - Added mandatory _connect_signals, _disconnect_signals, get_panel_buttons, and on_deployment_updated.

 - Integrated showEvent, hideEvent, and closeEvent lifecycle hooks to automatically attach/detach signals.

 - Added internal _timers tracking and _safe_disconnect_all() for auto cleanup on close.

- Custom Panel Refactors

 - LogWatcher, StreamViewer, Gameboard, PluginGuard, and others refactored to inherit the new interface.

 - Panels now cleanly connect on show and disconnect on hide ‚Üí no lingering bus listeners or zombie timers.

 - Added standardized _on_show, _on_hide, _on_close optional hooks for extended behavior.

## Matrix ‚Üí Phoenix Integration

- Matrix WebSocket Agent

 - Updated _cmd_broadcast and _secure_payload to encrypt outbound data with peer public key and sign using local private key.

 - Normalized message routing in cmd_rpc_route for direct session broadcast vs. full swarm broadcast.

 - Implemented cmd_send_alert_msg() for GUI-formatted alert packets (handler: swarm_feed.alert).

- Matrix HTTPS Agent

 - Hardened request verification (IP allowlist, SPKI pinning, signature guard).

 - Clean relay to Matrix via encrypted standard.command.packet.

## Signal Handling & Event Bus

- Implemented global bus off-switches in SessionWindow.closeEvent() for all inbound handlers.

- Bus now safely detaches all signals before process termination.

- Added _safe_disconnect_signals() and unified pattern for GUI panels to prevent double-connections.

## UI / UX Enhancements

- PhoenixStaticPanel

 - Built full Swarm Feed console with colored, iconized alert formatting via FeedFormatter.

 - Added deduplication logic (10s window) for repeated alerts.

 - Severity normalization (INFO, WARN, ERROR, ALERT, CRITICAL, EMERGENCY) with color + emoji mapping.

 - Deployed OS-level audio playback (winsound/afplay/aplay) to eliminate Qt audio access-violations on Windows.

 - Added new Alert Sound Settings section:

 - Dropdown auto-populates with all .wav files in matrix_gui/resources/sounds.

 - ‚ÄúPlay sound‚Äù checkbox toggles alert playback (default ‚úÖ).

 - Crash-proof threaded playback using native platform sound APIs.

- FeedFormatter

 - Extended icons and color maps for higher severity tiers.

 - HTML-safe output for rich QTextEdit display.

- Gameboard Panel

 - Added cowbell.wav event and grid update optimizations.

 - Thread-safe frame updates via QMetaObject.invokeMethod().

## Code Quality / Safety

- Removed redundant tab_index tracking; switched to widget references for consistent tab management.

- Ensured all subprocess terminations call .terminate() + .join(timeout=2) before final cleanup.

- Unified emit_gui_exception_log usage across all panels for uniform error reporting.

- Added docstrings and structured logging for MIRV and cockpit subsystems.

## Outcome

Phoenix Cockpit now:

 - Launches and tears down sessions deterministically.

 - Cleans up all IPC and bus links on exit without leaks.

 - Displays colored, audible, context-aware swarm alerts.

 - Provides modular panels that auto-manage their signals and timers.

 - Is crash-proof under Windows audio drivers.

 - Feels like a living swarm operations dashboard.

Co-authored by: Commander & ChatGPT-5 (The Generals)